<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Web3.js + MetaMask 本地网络交互</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <h1>与本地网络交互</h1>
    <button id="connect">连接 MetaMask</button>
    <p id="account"></p>
    <button id="balance">查询余额</button>
    <p id="balResult"></p>
    <button id="send">发送 0.01 ETH（测试）</button>

    <script>
        let web3;
        let userAccount;

        // 连接 MetaMask
        document.getElementById('connect').addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // 请求账户访问权限
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    // 初始化 Web3，使用 MetaMask provider
                    web3 = new Web3(window.ethereum);
                    document.getElementById('account').innerHTML = `已连接账户: ${userAccount}`;
                    
                    // 监听网络/账户变化
                    window.ethereum.on('accountsChanged', (accounts) => {
                        location.reload(); // 简单重载，生产环境可优化
                    });
                } catch (error) {
                    console.error('连接失败:', error);
                }
            } else {
                alert('请安装 MetaMask！');
            }
        });

        // 查询余额
        document.getElementById('balance').addEventListener('click', async () => {
            if (!web3 || !userAccount) {
                alert('先连接钱包！');
                return;
            }
            try {
                const balance = await web3.eth.getBalance(userAccount);
                const etherBalance = web3.utils.fromWei(balance, 'ether');
                document.getElementById('balResult').innerHTML = `余额: ${etherBalance} ETH`;
            } catch (error) {
                console.error('查询失败:', error);
            }
        });

        // 发送交易（示例：转账 0.01 ETH 到另一个账户）
        document.getElementById('send').addEventListener('click', async () => {
            if (!web3 || !userAccount) {
                alert('先连接钱包！');
                return;
            }
            try {
                // 替换为目标地址（例如 Ganache 的第二个账户）
                const toAddress = '0x...'; // 从 Ganache 获取
                const tx = {
                    from: userAccount,
                    to: toAddress,
                    value: web3.utils.toWei('0.01', 'ether'),
                    gas: 21000,
                    gasPrice: await web3.eth.getGasPrice()
                };
                const receipt = await web3.eth.sendTransaction(tx);
                alert(`交易成功！哈希: ${receipt.transactionHash}`);
            } catch (error) {
                console.error('发送失败:', error);
            }
        });
    </script>
</body>
</html>